{% extends 'base.html' %} 
{% block content %}
<body class="bg-gray-100 min-h-screen">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript">
    function scrollToBottom() {
      var messagesContainer = document.getElementById("messages");
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    var socketio = io.connect();
    socketio.on("message", function (message) {
      createChatItem(message.message, message.sender, message.created_at) 
    });

    function createChatItem(message, sender, created_at) {
      var messages = document.getElementById("messages");
      
      if (sender === "") {
        content = `<p class="text-center text-xs text-gray-500">${message}</p>`;
      } else {
        var senderIsUser = "{{user}}" === sender;
        if (senderIsUser) {
          var content = `
            <div class="flex justify-end mb-1">
              <div class="bg-blue-500 text-white rounded-lg py-1.5 px-3 max-w-[85%] break-words text-sm">
                ${message}
                <small class="text-xs text-gray-200 block text-right mt-0.5">${created_at}</small>
              </div>
            </div>
          `   
        } else {
          var content = `
            <div class="flex justify-start mb-1">
              <div class="bg-gray-300 rounded-lg py-1.5 px-3 max-w-[85%] break-words text-sm">
                ${message}
                <small class="text-xs text-gray-600 block text-left mt-0.5">${created_at}</small>
              </div>
            </div>
          `
        }
      }
      messages.innerHTML += content;
      scrollToBottom();
    }

    function sendMessage(event) {
      if (event && event.key && event.key !== 'Enter') return;
      
      var msgInput = document.getElementById("message-input");
      if (msgInput.value.trim() === "") return;
      
      var msg = msgInput.value;
      socketio.emit("message", { message: msg });
      msgInput.value = "";
      
      if (event && event.preventDefault) {
        event.preventDefault();
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
    }
  </script>
    
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" 
         onclick="closeSidebar()" 
         class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed md:relative w-64 bg-white border-r border-gray-200 h-full 
                              transform -translate-x-full md:translate-x-0 
                              transition-transform duration-300 ease-in-out 
                              z-50 flex flex-col">
      <!-- Friend List -->
      <div class="flex-1 overflow-y-auto">
        {% for chat in chats %}
        <a href="{{url_for('main.room',room_id = chat.room_code)}}" 
           class="block hover:bg-gray-50">
          <div class="flex items-center p-3 border-b border-gray-100 space-x-3">
            {% if current_user.id == chat.member_1 %}
              <img src="{{ url_for('static', filename='profile_pics/' + chat.user_2.image ) }}" 
                   alt="{{ chat.user_2.username }}" 
                   class="w-10 h-10 rounded-full object-cover">
              <h3 class="text-sm font-medium text-gray-900">{{chat.user_2.username}}</h3>
            {% else %}
              <img src="{{ url_for('static', filename='profile_pics/' + chat.user_1.image ) }}" 
                   alt="{{ chat.user_1.username }}" 
                   class="w-10 h-10 rounded-full object-cover">
              <h3 class="text-sm font-medium text-gray-900">{{chat.user_1.username}}</h3>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </div>

      <!-- User Profile -->
      <div class="border-t border-gray-200 p-3">
        <div class="flex items-center space-x-2">
          <img src="{{ url_for('static', filename='profile_pics/' + current_user.image) }}" 
               alt="{{user}}" class="w-8 h-8 rounded-full object-cover">
          <div class="flex-1">
            <p class="text-sm font-medium truncate">{{user}}</p>
            <div class="flex items-center space-x-1">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-xs text-gray-500">Online</span>
            </div>
          </div>
          <button onclick="toggleDropup()" class="p-1 hover:bg-gray-100 rounded-full">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      {% if room_exists %}
        <!-- Chat Header -->
        <div class="bg-white border-b border-gray-200 p-3 flex items-center space-x-2">
          <button onclick="toggleSidebar()" class="md:hidden p-1">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <h2 class="text-base font-semibold flex-1">{{ receiver_name}}</h2>
        </div>
        
        <!-- Message List -->
        <div id="messages" class="flex-1 overflow-y-auto p-3 space-y-1 bg-gray-50">
          {% for message in old_messages %}
            {% if message.sender_id == current_user.id %}
              <div class="flex justify-end">
                <div class="bg-blue-500 text-white rounded-lg py-1.5 px-3 max-w-[85%] break-words text-sm">
                  {{message.message}}
                  <small class="text-xs text-gray-200 block text-right mt-0.5">
                    {{message.created_at.strftime('%H:%M')}}
                  </small>
                </div>
              </div>
            {% else %}
              <div class="flex justify-start">
                <div class="bg-gray-300 rounded-lg py-1.5 px-3 max-w-[85%] break-words text-sm">
                  {{message.message}}
                  <small class="text-xs text-gray-600 block text-left mt-0.5">
                    {{message.created_at.strftime('%H:%M')}}
                  </small>
                </div>
              </div>
            {% endif %}
          {% endfor %}  
        </div>
        
        <!-- Message Input -->
        <div class="bg-white border-t border-gray-200 p-2">
          <form onsubmit="sendMessage(event)" class="flex space-x-2">
            <input type="text" id="message-input" 
                   placeholder="Message..." 
                   class="flex-1 px-2 py-1.5 text-sm border rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
            <button type="submit" 
                    class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-blue-600">
              Send
            </button>
          </form>
        </div>
      {% else %}
        <div class="flex items-center justify-center flex-1 p-4">
          <div class="bg-white p-4 rounded-lg text-center text-sm">
            Select a chat to start messaging
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    function toggleDropup() {
      const dropup = document.getElementById('dropupMenu');
      dropup.classList.toggle('hidden');
    }
  </script>
</body>
{% endblock %}